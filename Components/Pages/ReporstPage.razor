@page "/reports-page"
@using VillageRentalManagementSystem.Services
@using VillageRentalManagementSystem.Models.Reports
@inject ReportService reportService

<h3 class="mb-4">Generate Reports</h3>

<div class="card">
    <div class="card-header">
        <div class="btn-group w-100" role="group">
            <button type="button" class="btn @(selectedReport == "Date" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SelectReport("Date")'>Sales by Date</button>
            <button type="button" class="btn @(selectedReport == "Customer" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SelectReport("Customer")'>Sales by Customer</button>
            <button type="button" class="btn @(selectedReport == "Category" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SelectReport("Category")'>Sales by Category</button>
        </div>
    </div>
    <div class="card-body">
        @switch (selectedReport)
        {
            case "Date":
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-md-4">
                        <label class="form-label">Select Date:</label>
                        <input type="date" @bind="selectedDate" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success w-100" @onclick="GenerateDailyReport">Generate</button>
                    </div>
                </div>
                @if (dailySales != null)
                {
                    <h4 class="mt-4">Report for @selectedDate.ToShortDateString()</h4>
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Rental ID</th>
                                <th>Customer Name</th>
                                <th class="text-center"># of Items</th>
                                <th class="text-end">Total Sale</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in dailySales)
                            {
                                <tr>
                                    <td>@item.RentalId</td>
                                    <td>@item.CustFirstName @item.CustLastName</td>
                                    <td class="text-center">@item.NumberOfItems</td>
                                    <td class="text-end">@item.TotalSales.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <td colspan="3" class="text-end"><strong>Total Sales for Date:</strong></td>
                                <td class="text-end"><strong>@TotalSalesOfDate.ToString("C")</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                }
                break;

            case "Customer":
                <h4 class="mb-3">Total Sales by Customer</h4>
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Customer ID</th>
                            <th>Customer Name</th>
                            <th class="text-end">Total Amount Spent</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in customerSales)
                        {
                            <tr>
                                <td>@item.CustomerId</td>
                                <td>@item.CustomerName</td>
                                <td class="text-end">@item.TotalAmountSpent.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                </table>
                break;

            case "Category":
                <h4 class="mb-3">Total Sales by Category</h4>
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Category ID</th>
                            <th>Category Name</th>
                            <th class="text-end">Total Sales</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in categorySales)
                        {
                            <tr>
                                <td>@item.CategoryId</td>
                                <td>@item.CategoryName</td>
                                <td class="text-end">@item.TotalSales.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                </table>
                break;
        }
    </div>
</div>

@code {
    private string selectedReport = "Date"; // Default report to show

    private DateTime selectedDate;
    private List<DailySalesReportItem> dailySales;
    private List<CustomerSalesReportItem> customerSales;
    private List<CategorySalesReportItem> categorySales;

    private decimal TotalSalesOfDate => dailySales?.Sum(item => item.TotalSales) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        selectedDate = DateTime.Today;
        // Pre-load reports that don't need a parameter
        customerSales = await reportService.GetSalesByCustomerAsync();
        categorySales = await reportService.GetSalesByCategoryAsync();
    }

    private void SelectReport(string reportName)
    {
        selectedReport = reportName;
        dailySales = null; // Clear daily sales when switching reports
    }

    private async Task GenerateDailyReport()
    {
        dailySales = await reportService.GetSalesByDateAsync(selectedDate);
    }
}
