-- =================================================================
-- SQL Script for Village Rental Management System
-- =================================================================

-- Step 1: Drop existing tables to start fresh
PRINT 'Dropping existing tables...';
DROP TABLE IF EXISTS RentalItems;
DROP TABLE IF EXISTS Rentals;
DROP TABLE IF EXISTS Equipment;
DROP TABLE IF EXISTS Categories;
DROP TABLE IF EXISTS Customers;
GO

-- Step 2: Create the main tables
PRINT 'Creating tables...';

CREATE TABLE Customers (
    Id INT PRIMARY KEY IDENTITY(1,1),
    FirstName NVARCHAR(50) NOT NULL,
    LastName NVARCHAR(50) NOT NULL,
    PhoneNumber NVARCHAR(20),
    Email NVARCHAR(100) UNIQUE,
    IsBanned BIT NOT NULL DEFAULT 0,
    DiscountRate DECIMAL(5, 2) NOT NULL DEFAULT 0.00
);

CREATE TABLE Categories (
    Id INT PRIMARY KEY IDENTITY(1,1),
    Name NVARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE Equipment (
    Id INT PRIMARY KEY IDENTITY(1,1),
    Name NVARCHAR(100) NOT NULL,
    Description NVARCHAR(500),
    DailyRentalCost DECIMAL(10, 2) NOT NULL,
    IsAvailable BIT NOT NULL DEFAULT 1,
    CategoryId INT
);

CREATE TABLE Rentals (
    Id INT PRIMARY KEY IDENTITY(1,1),
    CustomerId INT NOT NULL,
    RentalDate DATETIME NOT NULL DEFAULT GETDATE(),
    ExpectedReturnDate DATETIME,
    TotalCost DECIMAL(10, 2)
);

-- CORRECTED RentalItems table
CREATE TABLE RentalItems (
    Id INT PRIMARY KEY IDENTITY(1,1),
    RentalId INT NOT NULL,
    EquipmentId INT NOT NULL,
    RentalCost DECIMAL(10, 2) NOT NULL,
    ExpectedReturnDate DATETIME NOT NULL, -- <<< THIS COLUMN IS NOW ADDED
    IsReturned BIT NOT NULL DEFAULT 0,
    ActualReturnDate DATETIME NULL
);
GO

-- Step 3: Add Foreign Key Constraints
PRINT 'Adding foreign key constraints...';

ALTER TABLE Equipment
ADD CONSTRAINT FK_Equipment_Categories
FOREIGN KEY (CategoryId) REFERENCES Categories(Id);

ALTER TABLE Rentals
ADD CONSTRAINT FK_Rentals_Customers
FOREIGN KEY (CustomerId) REFERENCES Customers(Id);

ALTER TABLE RentalItems
ADD CONSTRAINT FK_RentalItems_Rentals
FOREIGN KEY (RentalId) REFERENCES Rentals(Id);

ALTER TABLE RentalItems
ADD CONSTRAINT FK_RentalItems_Equipment
FOREIGN KEY (EquipmentId) REFERENCES Equipment(Id);
GO

PRINT 'Script execution completed successfully.';
GO
